import csv
import sys

from utils.database_utils.database_extractor import extract_features


def get_features_by_family_from_csv(family_name, csv_file_path):
    feature_dicts = {}
    maxInt = sys.maxsize

    while True:
        # Increase the field size limit
        try:
            csv.field_size_limit(maxInt)
            break
        except OverflowError:
            maxInt = int(maxInt / 10)


    with open(csv_file_path, mode='r', newline='', encoding='utf-8') as csvfile:
        reader = csv.DictReader(csvfile)
        for row in reader:
            if row['family_name'] == family_name:
                sha = row['sha']
                llm_text = row['llm_text']
                if llm_text:
                    dictio = extract_features(llm_text)
                    feature_dicts[sha] = dictio

    return feature_dicts